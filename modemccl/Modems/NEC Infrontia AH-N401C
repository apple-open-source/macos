!********************************************************************!	AirH" AH-N401C!!	Copyright: 2000-2003 NEC Infrontia Corp. All Rights Reserved.!!	revision history:!		Ver 1.0 (Nakamura)	First Version!!	'mlts' resource info for this modem:!	  byte 1 == 01 -> modem HAS built-in error correction protocols!	  byte 2 == 01 -> modem HAS built-in data compression protocols!	  byte 3 == 64 -> max number of chars in varstr 7!	  byte 4 == 64 -> max number of chars in varstr 8!	  byte 5 == 64 -> max number of chars in varstr 9!********************************************************************!@ORIGINATE@ANSWER!********************************************************************!	---- Initial modem setup ----!********************************************************************IfStr 5 1 "0"SerReset 115200, 0, 8, 1Jump 2!@LABEL 1SerReset 115200, 0, 8, 1!@LABEL 2HSReset 0 0 0 0 0 0SetTries 0!!!********************************************************************!	Get the modem's attention!********************************************************************MatchClrMatchStr 1 3 "OK\13\10"Write "AT\13"MatchRead 30!!@LABEL 3!********************************************************************!	Setup the modem for the following:!		&F	:	Recall Factory Setting!		&D2	:	Enable DTR-control!		E0	:	Echo Off!		V1	:	Display Result-Code with String Messages!		X4	:	Enable Extend Result-Code!		\V1	:	Display Extend Result-Code1!		\X1	:	Display Extend Result-Code2!		S0=0	:	Disable Auto Answer!********************************************************************MatchClrMatchStr 1   4 "OK\13\10"MatchStr 2 101 "ERROR\13\10"Write "AT&F&D2E0V1X4\\V1\\X1S0=0\13"MatchRead 30IncTriesIfTries 3 101!!!********************************************************************!	Reset the Modem on setup failure!********************************************************************DTRClearPause 5DTRSetFlushJump 3!!@LABEL 4!********************************************************************!	Varstring 4 , reliable link protocol:!		= 0, handled by computer (ARAP)!		= 1, handled by modem (PPP)!		= 2, MNP10 protocol (Cellular protocol, no longer supported)!********************************************************************IfStr 4 5 "1"IfStr 4 5 "2"!! Varstring 4 == 0, turn off reliable link protocol in modem (ARAP)MatchClrMatchStr 1 9 "OK\13\10"Write "AT\13"MatchRead 30Jump 101!!@LABEL 5!********************************************************************!	Varstring 5, compression protocol:!		= 0, handled by computer !		= 1, handled by modem!********************************************************************IfStr 5 9 "1"!! Varstring 5 == 0, turn off compression protocol in modem.MatchClrMatchStr 1 9 "OK\13\10"Write "AT\13"MatchRead 30Jump 101!!!********************************************************************!	Modem ready, wait for a call or originate a call!********************************************************************@LABEL 9IfAnswer 32!!!********************************************************************!	---- Originating a call ----!	Varstring 6, dialing mode:!		= 0, normal dialing!		= 1, blind dialing!		= 2, manual dialing!********************************************************************IfStr 6 19 "1"IfStr 6 15 "2"Jump 19!!@LABEL 15! Display ASK dialog with message.  Goto label 107 if dialog canceled.Ask 2 "Pick up the phone & dial ^1.  Hit OK when the phone rings, then hangup." 107Note "Manual dialing initiated" 3!@LABEL 19! Display the full dialstring contained in Varstring 1Note "Dialing ^1" 3!!!********************************************************************!	Varstrings 7, 8 and 9, contain dialstring fragments!		Long phone numbers may need to be split into smaller groups!		for the modem to use!!		Varstring 3:  "p" for pulse & "t" for tone dialing (NOT USE)!		Varstring 8 == blank (dialstring in varstring 7)!		Varstring 9 == blank (dialstring in varstrings 7 & 8)!		Otherwise (dialstring in varstrings 7, 8 & 9)!		\^ is added to the dialstring to force the modem to generate a data tone!********************************************************************IfStr 8 27 " "IfStr 9 24 " "!!  Write dialstring in varstrings 7, 8 & 9MatchClrMatchStr 1 21 "OK\13\10"Write "ATD^7;\13"MatchRead 400Jump 101!@LABEL 21MatchClrMatchStr 1 22 "OK\13\10"Write "ATD^8;\13"MatchRead 400Jump 101!@LABEL 22Write "ATD^9\13"Jump 32!!@LABEL 24!  Write dialstring in varstrings 7 & 8MatchClrMatchStr 1 25 "OK\13\10"Write "ATD^7;\13"MatchRead 400Jump 101!@LABEL 25Write "ATD^8\13"Jump 32!@LABEL 27!  Write dialstring in varstring 7Write "ATD^7\13"!!!********************************************************************!	---- Connection responce ----!	The following section will parse modem responces of two types:!		1) PROTOCOL: xxx, COMPRESSION: xxx, CONNECT xxx!		2) CONNECT xxx/ARQ/V42!********************************************************************@LABEL 32MatchClrMatchStr 1  81 "RING\13\10"MatchStr 2 103 "NO CARRIER"MatchStr 3 103 "ERROR\13\10"MatchStr 4 104 "BUSY\13\10"MatchStr 5 103 "DELAYED\13\10"MatchStr 6  33 "CONNECT "MatchRead 700IfAnswer 32Jump 101!!********************************************************************!	Parse the speed of connect result codes!	2400 and 4800 have two entries each!	to distinguish them from 24000 and 48000!********************************************************************@LABEL 33MatchClrMatchStr 1 40 "115200\13"MatchStr 2 41 "115200 / 32kPIAFS"MatchStr 3 42 "115200 / 64kPIAFS GR"MatchStr 4 43 "115200 / 64kPIAFS BE"MatchStr 5 44 "115200 / 32kPACKET"MatchStr 6 45 "115200 / 128kPACKET"MatchStr 7 46 "115200 / 64kAO/DI"MatchRead 30Jump 59!!!********************************************************************!	-- Connection rates --!	CommunicatingAt informs ARA of the raw modem to modem!	connection speed.!********************************************************************@LABEL 40Note "Communicating at 115200 bps." 2CommunicatingAt 115200Jump 70!@LABEL 41Note "Communicating at 32 kbps (32k PIAFS)." 2CommunicatingAt 32000Jump 70!@LABEL 42Note "Communicating at 64 kbps (64k PIAFS GR)." 2CommunicatingAt 64000Jump 70!@LABEL 43Note "Communicating at 64 kbps (64k PIAFS BE)." 2CommunicatingAt 64000Jump 70!@LABEL 44Note "Communicating at 32 kbps (32k PACKET)." 2CommunicatingAt 32000Jump 70!@LABEL 45Note "Communicating at 128 kbps (128k PACKET)." 2CommunicatingAt 128000Jump 70!@LABEL 46Note "Communicating at 64 kbps (64k AO/DI)." 2CommunicatingAt 64000Jump 70!@LABEL 59Note "Communicating at 115200 bps." 2CommunicatingAt 115200Jump 70!!********************************************************************!	-- Normal exit after "CONNECT" --!		This modem has been setup to do CTS handshaking,!		and we assume that a CTS handshaking cable is being used.!********************************************************************@LABEL 70! Turn on CTS handshaking.HSReset 0 1 0 0 0 0!IfAnswer 71Pause 5@LABEL 71Exit 0!!!********************************************************************!	---- Answer calls ----!		A RING result from the modem and in ANSWERING mode!		claims the serial port and answering the phone!********************************************************************@LABEL 81IfOriginate 32UserHook 1Note "Answering phone..." 2Write "ATA\13"Jump 32!!!********************************************************************!	---- Hang up and reset modem ----!********************************************************************@HANGUP@LABEL 90SetTries 0HSReset 0 0 0 0 0 0!@LABEL 92!  Escape from data to command modeMatchClrMatchStr 1 96 "OK\13\10"Write "+++"MatchRead 20!@LABEL 94! Force a hangupMatchClrMatchStr 1 98 "NO CARRIER\13\10"MatchStr 2 98 "OK\13\10"MatchStr 3 98 "ERROR\13\10"Write "ATH\13"MatchRead 30! ! Try to get control of the modem by toggling DTRDTRClearPause 5DTRSetFlush!! Try the hangup sequence three times otherwise declare and errorIncTriesIfTries 3 101Jump 92!@LABEL 96! Pause between data and command modePause 50Jump 94!!@LABEL 98! Recall the factory settingsPause 15MatchClrMatchStr 1 99 "OK\13\10"Write "AT&F\13"MatchRead 30Jump 101!@LABEL 99exit 0!!!********************************************************************! ---- Error messages -----!********************************************************************! Modem Not Responding@LABEL 101exit -6019!! No Dial Tone@LABEL 102exit -6020!! No Carrier or Error@LABEL 103exit -6021!! Busy@LABEL 104exit -6022!! No Answer@LABEL 105exit -6023!! User Cancellation@LABEL 107exit -6008